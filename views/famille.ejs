<% include header %>
<!-- mathieu -->
<section class="container">

    <h2 class="my-4 ml-2">
      <svg class="bi bi-person-lines-fill" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M1 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H1zm5-6a3 3 0 100-6 3 3 0 000 6zm7 1.5a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5zm-2-3a.5.5 0 01.5-.5h4a.5.5 0 010 1h-4a.5.5 0 01-.5-.5zm0-3a.5.5 0 01.5-.5h4a.5.5 0 010 1h-4a.5.5 0 01-.5-.5zm2 9a.5.5 0 01.5-.5h2a.5.5 0 010 1h-2a.5.5 0 01-.5-.5z" clip-rule="evenodd"/>
      </svg>
      Mon entourage
    </h2>
    <div class="row">
        <% var familleBis = famille; %>
        <% for (famille of famille){ %>
            <div class="card m-3" style="width: 18rem; background-color: RGB(237, 237, 237);">
                <div class="card-body">
                    <h5 class="card-title"><%= famille.nom %></h5>
                    <% if (famille.type == 1 ){ %>
                        <h6 class="card-subtitle mb-2 text-muted">Enfant</h6>
                    <% } else { %>
                        <h6 class="card-subtitle mb-2 text-muted">Adulte</h6>
                    <% } %>
                    <!-- zone de modification -->
                    <div class="row">
                        <form action="/famille" method="post" class="col-4">
                            <input id="form" name="form" type="hidden" value="remove">
                            <input id="id" name="id" type="hidden" value="<%= famille.id %>">
                            <button type="submit" class="btn btn-outline-danger">Supprimer</button>
                        </form>

                        <a href="/modifier_famille/<%= famille.id %>" class="btn btn-outline-warning col-4 offset-3">Modifier</a>
                    </div>
                    <div class="form-row mt-3">
                        <!--Zone de specification des regime alimentaire -->
                        <a class="btn text-light col-10 offset-1" style="background-color: RGBA(12, 184, 182, 0.91);"
                           href="#collapsespec_<%= famille.nom %>" data-toggle="collapse" aria-expanded="false"
                           aria-controls="collapsespec">Spécification alimentaire<i
                                    class="fas fa-angle-down rotate-icon pl-2"></i></a>

                        <ul id="collapsespec_<%= famille.nom %>"
                            class="collapse list-group list-group-flush mt-3 offset-1">
                            <% var loop = specAlim; %>
                            <% var i = 0; %>
                            <% for (loop of loop){ %>
                                <% if (famille.id == loop.id_famille ){ %>
                                    <li class="list-group-item"
                                        style="background-color: RGB(250, 230, 230);"><%= loop.nom %></li>
                                <% i++;} %>
                            <% } %>
                            <% if (i == 0) { %>
                                <p>Pas de spécification alimentaire</p>
                            <% } %>
                        </ul>
                    </div>
                </div>
            </div>
        <% } %>

        <div class="card m-3" style="width: 18rem;">
            <form action="/famille" method="post">
                <input id="form" name="form" type="hidden" value="add">
                <div class="row pt-3">
                    <input type="text" id="Nom" name="nom" placeholder="Prénom" class="col-md-8 offset-md-1 rounded"
                           required>
                </div>
                <div class="row pt-3">
                    <div class="form-check form-check-inline offset-md-1">
                        <input class="form-check-input" type="radio" name="type" id="ageChoixAdulte" value="0" checked>
                        <label class="form-check-label" for="ageChoixAdulte">Adulte</label>
                    </div>
                    <div class="form-check form-check-inline offset-md-1">
                        <input class="form-check-input" type="radio" name="type" id="ageChoixEnfant" value="1">
                        <label class="form-check-label" for="ageChoixEnfant">Enfant</label>
                    </div>
                </div>

                <!-- Button trigger modal -->
                <div class="row pt-3">
                    <button type="button" class="btn btn-default text-light col-md-10 offset-md-1"
                            style="background-color: RGBA(12, 184, 182, 0.91);" data-toggle="modal"
                            data-target="#exampleModal">
                        Spécification alimentaire
                    </button>
                </div>

                <!-- Modal -->
                <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog"
                     aria-labelledby="exampleModalLabel" aria-hidden="true">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel">Spécifications alimentaires</h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                            </div>
                            <div class="modal-body">

                                <!-- Spec alimentaire -->
                                <% for (allSA of allSA){ %>
                                    <div>
                                        <input type="checkbox" id="<%= allSA.id %>" name="specAlim"
                                               value="<%= allSA.id %>">
                                        <label for="<%= allSA.id %>"><%= allSA.nom %></label>
                                    </div>
                                <% } %>

                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-primary"
                                        style="background-color: RGBA(12, 184, 182, 0.91);" data-dismiss="modal">
                                    Sauvegarder
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="row pt-3 pb-3">
                    <button type="submit" class="btn btn-outline-success offset-md-1 offset-xs-4">+ Ajouter</button>
                </div>

            </form>
        </div>
    </div>

    <!-- Debut du planing -->
    <h2 class="my-4 ml-2">
      <!-- Icon calendrier -->
      <svg class="bi bi-table" width="1em" height="1em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
        <path fill-rule="evenodd" d="M14 1H2a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1zM2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2z" clip-rule="evenodd"/>
        <path fill-rule="evenodd" d="M15 4H1V3h14v1z" clip-rule="evenodd"/>
        <path fill-rule="evenodd" d="M5 15.5v-14h1v14H5zm5 0v-14h1v14h-1z" clip-rule="evenodd"/>
        <path fill-rule="evenodd" d="M15 8H1V7h14v1zm0 4H1v-1h14v1z" clip-rule="evenodd"/>
        <path d="M0 2a2 2 0 012-2h12a2 2 0 012 2v2H0V2z"/>
      </svg>
      Mon Planning
    </h2>
    <!-- Tableau du planing -->
    <table class="table table-striped  table-borderless shadow-sm">
        <!-- Entete du tableau -->
        <thead class="thead-light">
          <tr>
              <th scope="col">Jour</th>
              <th scope="col">Petit Dejeuner</th>
              <th scope="col">Dejeuner</th>
              <th scope="col">Gouter</th>
              <th scope="col">Dinner</th>
          </tr>
        </thead>
        <!-- Corps du tableau -->
        <tbody>
        <!-- Affichage du tableau -->
        <% var semaine = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi', 'Samedi', 'Dimanche']; %>
        <% semaine.forEach((jour, i) => { %>
            <tr>
                <!-- Premiere colonne du tableau -->
                <th scope="row">
                    <%= jour  %>
                    <h6><% var loop4 = recetteFav; %></h6>
                    <!-- Button + qui active modal pop-up ajout nouveaux plats -->
                    <button style="color:grey;" type="button" name="btn-add-plat" class="btn" data-toggle="modal" data-target="#popup-add-plat-<%= i %>">
                      <svg class="bi bi-plus-circle" width="40px" height="40px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                        <path fill-rule="evenodd" d="M8 3.5a.5.5 0 01.5.5v4a.5.5 0 01-.5.5H4a.5.5 0 010-1h3.5V4a.5.5 0 01.5-.5z" clip-rule="evenodd"/>
                        <path fill-rule="evenodd" d="M7.5 8a.5.5 0 01.5-.5h4a.5.5 0 010 1H8.5V12a.5.5 0 01-1 0V8z" clip-rule="evenodd"/>
                        <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                      </svg>
                    </button>
                    <!-- Formulaires ajout nouveaux plats -->
                    <div id="popup-add-plat-<%= i %>" class="modal fade" role="dialog">
                      <div class="modal-dialog">
                        <div class="modal-content bg-light p-4">
                          <div class="modal-header">
                            <h5>Choisisez votre plat pour le <%= jour %> </h5>
                          </div>
                          <div class="modal-body">
                            <form action="/famille" method="post">
                                <input type="hidden" name="form" value="addRP">
                                <input type="hidden" name="jour" value="<%= i + 1 %>">
                                <div class="form-group">
                                  <label for="select-plat-<%= i %>"> Quel plat ?</label>
                                  <select id="select-plat-<%= i %>" class="form-control" name="idRecette">
                                      <% for (loop4 of loop4){ %>
                                          <option value="<%= loop4.id_recette %>"> <%= loop4.nom %> </option>
                                      <% } %>
                                  </select>
                                </div>
                                <div class="form-group">
                                  <label for="select-mm-<%= i %>"> Quel moment ? </label>
                                  <select id="select-mm-<%= i %>" class="form-control" name="moment">
                                      <option value="1">petit Dejeuner</option>
                                      <option value="2">Dejeuner</option>
                                      <option value="3">Gouter</option>
                                      <option value="4">Dinner</option>
                                  </select>
                                </div>
                                <button type="submit" class="btn btn-outline-success"> Ajouter </button>
                            </form>
                          </div>
                        </div>
                      </div>
                    </div>
                </th>
                <!-- Deuxieme colonne du tableau -->
                <% for(var j = 0;j < 4;j++){ %>
                    <td class="col-3">
                        <% var loop = planning; %>
                        <% for (loop of loop){ %>
                            <div class="mb-2 bg-light shadow rounded">
                                <% if(loop.jour == i + 1 && loop.moment == j + 1){ %>
                                      <!-- Affichage recette du jour dans planing -->
                                      <div class=" border-0 mt-2">
                                        <!-- Formulaire suppresion plat -->
                                        <form action="/famille" method="post">
                                            <input type="hidden" name="form" value="removeRP">
                                            <input type="hidden" name="idPlanning" value="<%= loop.idP %>">
                                            <!-- Croix pour suppresion -->
                                            <button id="btn-close-plat" type="submit" class="close" aria-label="Close">
                                              <span aria-hidden="true">&times;</span>
                                            </button>
                                        </form>
                                        <!-- Nom du plat et iamge du plat -->
                                        <div class="pt-5 pb-5 pl-3 pr-3 mb-2 bg-plat-planing rounded-top">
                                          <div class="nom-plat-planing">
                                            <h5 class="text-center pt-1"><%= loop.nom %></h5>
                                          </div>
                                        </div>
                                        <div class="ml-2">
                                          <!-- Formulaire ajout personne repas -->
                                          <h6>Prevoir pour</h6>
                                          <form action="/famille" method="post" class="row">
                                              <input type="hidden" name="form" value="addFP">
                                              <input type="hidden" name="idPlanning" value="<%= loop.idP %>">
                                              <div class="form-group col-9">
                                                <select class="form-control" name="idFamille">
                                                    <% var loop3 = familleBis; %>
                                                    <% for (famille of loop3){ %>
                                                        <option value="<%= famille.id %>"><%= famille.nom %></option>
                                                    <% } %>
                                                </select>
                                              </div>
                                              <button type="submit" class="col-2 btn">
                                                <svg class="bi bi-plus-square btn-outline-success" width="2em" height="2em" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                  <path fill-rule="evenodd" d="M8 3.5a.5.5 0 01.5.5v4a.5.5 0 01-.5.5H4a.5.5 0 010-1h3.5V4a.5.5 0 01.5-.5z" clip-rule="evenodd"/>
                                                  <path fill-rule="evenodd" d="M7.5 8a.5.5 0 01.5-.5h4a.5.5 0 010 1H8.5V12a.5.5 0 01-1 0V8z" clip-rule="evenodd"/>
                                                  <path fill-rule="evenodd" d="M14 1H2a1 1 0 00-1 1v12a1 1 0 001 1h12a1 1 0 001-1V2a1 1 0 00-1-1zM2 0a2 2 0 00-2 2v12a2 2 0 002 2h12a2 2 0 002-2V2a2 2 0 00-2-2H2z" clip-rule="evenodd"/>
                                                </svg>
                                              </button>
                                          </form>
                                        </div>
                                    </div>
                                    <% var loop2 = planningF; %>
                                    <% var nbEnfant = 0; %>
                                    <% var nbAdulte = 0; %>
                                    <!-- Liste des personnes prevus pour le repas -->
                                    <div class="ml-2 bg-light border-0">
                                      <h6>Prévu pour</h6>
                                      <ul class="list-group ">
                                      <% for (loop2 of loop2){ %>
                                          <% if(loop.idP == loop2.id_planning){ %>
                                              <% if (loop2.type == 1) {
                                                  nbEnfant++;
                                              } else {
                                                  nbAdulte++;
                                              } %>
                                                <li class="list-group-item border-0 bg-light p-0">
                                                  <!-- Formulaire pour supprimer une personne prevue pour un repas -->
                                                  <form action="/famille" method="post">
                                                      <input type="hidden" name="form" value="removeFP">
                                                      <input type="hidden" name="idPlanning" value="<%= loop2.id_planning %>">
                                                      <input type="hidden" name="idFamille" value="<%= loop2.id_famille %>">
                                                      <!-- Button supprimer une personne du repas -->
                                                      <button type="button" style="color: #C4151C; font-size: 40px; line-height: 0" class="btn" aria-label="Close">
                                                        <!-- Icon - encerclée -->
                                                        <svg class="bi bi-dash-circle btn-outline-danger rounded" width="20px" height="20px" viewBox="0 0 16 16" fill="currentColor" xmlns="http://www.w3.org/2000/svg">
                                                          <path fill-rule="evenodd" d="M8 15A7 7 0 108 1a7 7 0 000 14zm0 1A8 8 0 108 0a8 8 0 000 16z" clip-rule="evenodd"/>
                                                          <path fill-rule="evenodd" d="M3.5 8a.5.5 0 01.5-.5h8a.5.5 0 010 1H4a.5.5 0 01-.5-.5z" clip-rule="evenodd"/>
                                                        </svg>
                                                      </button>
                                                      <span class=" "><%= loop2.nom %></span>
                                                  </form>
                                                </li>
                                          <% } %>
                                      <% } %>
                                      </ul>
                                    </div>
                                    <!-- Button voir la recette -->
                                    <form action="/recette/<%= loop.id %>" method="get" class="bg-light text-center pt-1 pb-1 rounded-bottom">
                                        <input type="hidden" name="nbAdulte" value="<%= nbAdulte %>">
                                        <input type="hidden" name="nbEnfant" value="<%= nbEnfant %>">
                                        <button type="submit" class="btn btn-info mb-2"> Voir la recette </button>
                                    </form>
                                <% } %>
                            </div>
                        <% } %>
                    </td>
                <% } %>
            </tr>
        <!-- Fin affichage ligne du tableau -->
        <% }); %>
        </tbody>
    </table>
</section>
<% include footer %>
